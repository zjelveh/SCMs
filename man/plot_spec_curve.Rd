% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/plot_spec_curve.R
\name{plot_spec_curve}
\alias{plot_spec_curve}
\title{Plot Specification Curve with Perfect SHAP Alignment}
\usage{
plot_spec_curve(
  long_data,
  name_treated_unit,
  outcomes,
  normalize_outcomes = "none",
  rmse_threshold = Inf,
  shap_values = NULL,
  file_path_save = NA,
  width = 6,
  height = 10,
  show_pvalues = TRUE,
  p_threshold = 0.05,
  pvalue_style = "continuous",
  prefer_bootstrap_pvalues = FALSE,
  test_statistic = "rmse_ratio",
  null_distribution = "placebo",
  crop_outliers = "none",
  sort_by = "tau"
)
}
\arguments{
\item{long_data}{Data.table or List. Long format data from spec_curve().
Can be either the results data.table directly, or the full structured results
(with results, abadie_inference, bootstrap_inference components).}

\item{name_treated_unit}{Character. Name of the treated unit.}

\item{outcomes}{Character vector. Names of the outcome variables to plot.}

\item{normalize_outcomes}{Character. Method for normalizing treatment effects for comparability.
Options: "none" (default), "percent_of_mean", "percent_of_preperiod", "standardized", "rmspe_ratio".
\itemize{
\item "percent_of_mean": (tau / mean(pre-period treated)) * 100
\item "percent_of_preperiod": (tau / final_preperiod_value) * 100
\item "standardized": tau / sd(control_effects)
\item "rmspe_ratio": post_RMSPE / pre_RMSPE (Abadie-style)
}}

\item{rmse_threshold}{Numeric. Threshold for root mean square error to filter results. Default is Inf.}

\item{shap_values}{Data.table or NULL. SHAP values from run_xgboost_shap_analysis().
Should contain full_spec_id column for perfect alignment. Default is NULL.}

\item{file_path_save}{Character or NA. File path to save the plot. If NA, plot is not saved. Default is NA.}

\item{width}{Numeric. Width of the saved plot in inches. Default is 6.}

\item{height}{Numeric. Height of the saved plot in inches. Default is 10.}

\item{show_pvalues}{Logical. Whether to include significance coloring for treatment effects.
Uses Abadie p-values by default, or bootstrap p-values if available. Default is TRUE.}

\item{p_threshold}{Numeric. P-value threshold for significance coloring. Default is 0.05.}

\item{pvalue_style}{Character. Style for p-value visualization. Options: "continuous" (default) or "categorical".
\itemize{
\item "continuous": Uses -log10(p-value) color scale with continuous gradation
\item "categorical": Uses discrete significance categories (original behavior)
}}

\item{prefer_bootstrap_pvalues}{Logical. Whether to prefer bootstrap p-values over Abadie p-values
when both are available. Default is FALSE (prefer Abadie).}

\item{test_statistic}{Character. Which test statistic p-values to use for coloring.
Options: "rmse_ratio" (default), "treatment_effect", "normalized_te".
Only applies to Abadie placebo inference which provides multiple test statistics.}

\item{null_distribution}{Character. The distribution to plot as the null/comparison.
Options: "placebo" (default) or "bootstrap".
\itemize{
\item "placebo": Use placebo effects from control units as the null distribution.
\item "bootstrap": Use the bootstrapped null distribution for the treated unit.
}}

\item{crop_outliers}{Character or Numeric. Method for cropping outliers in Panel A.
Options: "none" (default), "percentile", "iqr", "mad", or numeric vector c(ymin, ymax).
\itemize{
\item "percentile": Crop to 1st-99th percentile of treated unit effects
\item "iqr": Crop to Q1 - 1.5\emph{IQR to Q3 + 1.5}IQR
\item "mad": Crop to median Â± 3*MAD (robust outlier detection)
\item c(ymin, ymax): Manual y-axis limits
}}

\item{sort_by}{Character. Method for sorting specifications on x-axis.
Options: "tau" (default), "pvalue", "rmspe_ratio".
\itemize{
\item "tau": Sort by treatment effect magnitude (original behavior)
\item "pvalue": Sort by statistical significance (most significant first)
\item "rmspe_ratio": Sort by post/pre RMSPE ratio
}}
}
\value{
A ggplot object representing the specification curve.
}
\description{
Creates specification curve plots directly from long format data,
ensuring perfect alignment between SHAP values and specifications through
shared full_spec_id identifiers.
}
\details{
Plot Specification Curve Using Direct Long Format Data
}
\examples{
\dontrun{
# New recommended workflow with perfect alignment

# 1. Generate long format data with bootstrap inference
spec_results_long <- run_spec_curve_analysis(
  dataset, 
  params = params,
  inference_type = "bootstrap"
)

# 2. Run SHAP analysis
shap_results <- run_catboost_shap_analysis(spec_results_long, config)

# 3. Plot using placebo null with continuous p-values (default - RMSE ratio)
plot_rmse_ratio <- plot_spec_curve(
  long_data = spec_results_long,
  name_treated_unit = "TREATED_ID",
  shap_values = shap_results$shapley,
  test_statistic = "rmse_ratio",
  pvalue_style = "continuous"
)

# 4. Plot using treatment effect test statistic p-values
plot_treatment_effect <- plot_spec_curve(
  long_data = spec_results_long,
  name_treated_unit = "TREATED_ID",
  shap_values = shap_results$shapley,
  test_statistic = "treatment_effect",
  pvalue_style = "continuous"
)

# 5. Plot using normalized treatment effect test statistic p-values
plot_normalized_te <- plot_spec_curve(
  long_data = spec_results_long,
  name_treated_unit = "TREATED_ID",
  shap_values = shap_results$shapley,
  test_statistic = "normalized_te",
  pvalue_style = "categorical"
)
}
}
