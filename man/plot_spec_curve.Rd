% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/plot_spec_curve.R
\name{plot_spec_curve}
\alias{plot_spec_curve}
\title{Plot Specification Curve with Perfect SHAP Alignment}
\usage{
plot_spec_curve(
  long_data,
  name_treated_unit,
  outcomes = NULL,
  normalize_outcomes = "none",
  rmse_threshold = Inf,
  shap_values = NULL,
  file_path_save = NA,
  width = 6,
  height = 10,
  show_pvalues = TRUE,
  p_threshold = 0.05,
  prefer_bootstrap_pvalues = FALSE,
  test_statistic = "rmse_ratio",
  null_distribution = "placebo",
  crop_outliers = "none",
  sort_by = "tau",
  calculate_shap_pvalues = TRUE,
  shap_pvalue_type = "absolute"
)
}
\arguments{
\item{long_data}{Data.table or List. Long format data from spec_curve().
Can be either the results data.table directly, or the full structured results
(with results, abadie_inference, bootstrap_inference components).}

\item{name_treated_unit}{Character. Name of the treated unit.}

\item{outcomes}{Character vector or NULL. Names of the outcome variables to plot. If NULL, all outcomes in the data will be plotted.}

\item{normalize_outcomes}{Character. Method for normalizing treatment effects for comparability.
Options: "none" (default), "percent_of_mean", "percent_of_preperiod", "standardized", "rmspe_ratio".
\itemize{
\item "percent_of_mean": (tau / mean(pre-period treated)) * 100
\item "percent_of_preperiod": (tau / final_preperiod_value) * 100
\item "standardized": tau / sd(control_effects)
\item "rmspe_ratio": post_RMSPE / pre_RMSPE (Abadie-style)
}}

\item{rmse_threshold}{Numeric. Threshold for root mean square error to filter results. Default is Inf.}

\item{shap_values}{Data.table or NULL. SHAP values from run_catboost_shap_analysis().
Should contain full_spec_id column for perfect alignment. Default is NULL.}

\item{file_path_save}{Character or NA. File path to save the plot. If NA, plot is not saved. Default is NA.}

\item{width}{Numeric. Width of the saved plot in inches. Default is 6.}

\item{height}{Numeric. Height of the saved plot in inches. Default is 10.}

\item{show_pvalues}{Logical. Whether to include significance coloring for treatment effects.
Uses Abadie p-values by default, or bootstrap p-values if available. Default is TRUE.}

\item{p_threshold}{Numeric. P-value threshold for significance coloring. Default is 0.05.}

\item{prefer_bootstrap_pvalues}{Logical. Whether to prefer bootstrap p-values over Abadie p-values
when both are available. Default is FALSE (prefer Abadie).}

\item{test_statistic}{Character. Which test statistic p-values to use for coloring.
Options: "rmse_ratio" (default), "treatment_effect", "normalized_te".
Only applies to Abadie placebo inference which provides multiple test statistics.}

\item{null_distribution}{Character. The distribution to plot as the null/comparison.
Options: "placebo" (default) or "bootstrap".
\itemize{
\item "placebo": Use placebo effects from control units as the null distribution.
\item "bootstrap": Use the bootstrapped null distribution for the treated unit.
}}

\item{crop_outliers}{Character or Numeric. Method for cropping outliers in Panel A.
Options: "none" (default), "percentile", "iqr", "mad", or numeric vector c(ymin, ymax).
\itemize{
\item "percentile": Crop to 1st-99th percentile of treated unit effects
\item "iqr": Crop to Q1 - 1.5\emph{IQR to Q3 + 1.5}IQR
\item "mad": Crop to median Â± 3*MAD (robust outlier detection)
\item c(ymin, ymax): Manual y-axis limits
}}

\item{sort_by}{Character. Method for sorting specifications on x-axis.
Options: "tau" (default), "pvalue", "rmspe_ratio".
\itemize{
\item "tau": Sort by treatment effect magnitude (original behavior)
\item "pvalue": Sort by statistical significance (most significant first)
\item "rmspe_ratio": Sort by post/pre RMSPE ratio
}}

\item{calculate_shap_pvalues}{Logical. Whether to automatically calculate SHAP significance when
multi-unit SHAP data is available. When TRUE (default), if SHAP values for control units are
found, calculates p-values for treated unit's feature importance and displays significance via
point transparency. Set to FALSE to disable SHAP significance testing.}

\item{shap_pvalue_type}{Character. Method for calculating SHAP p-values.
Options: "absolute" (default) or "signed".
\itemize{
\item "absolute": Calculates p-values based on the absolute magnitude of SHAP values.
\item "signed": Calculates p-values based on the signed magnitude, considering positive and negative effects separately.
}}
}
\value{
A ggplot object representing the specification curve.
}
\description{
Creates specification curve plots directly from long format data,
ensuring perfect alignment between SHAP values and specifications through
shared full_spec_id identifiers.
}
\details{
Plot Specification Curve Using Direct Long Format Data
}
\examples{
\dontrun{
# New recommended workflow with perfect alignment

# 1. Generate long format data with bootstrap inference
spec_results_long <- run_spec_curve_analysis(
  dataset,
  params = params,
  inference_type = "bootstrap"
)

# 2. Run SHAP analysis
shap_results <- run_catboost_shap_analysis(spec_results_long, config)

# 3. Plot using placebo null with continuous p-values (default - RMSE ratio)
plot_rmse_ratio <- plot_spec_curve(
  long_data = spec_results_long,
  name_treated_unit = "TREATED_ID",
  shap_values = shap_results$shapley,
  test_statistic = "rmse_ratio"
)

# 4. Plot using treatment effect test statistic p-values
plot_treatment_effect <- plot_spec_curve(
  long_data = spec_results_long,
  name_treated_unit = "TREATED_ID",
  shap_values = shap_results$shapley,
  test_statistic = "treatment_effect"
)

# 5. Plot using normalized treatment effect test statistic p-values
plot_normalized_te <- plot_spec_curve(
  long_data = spec_results_long,
  name_treated_unit = "TREATED_ID",
  shap_values = shap_results$shapley,
  test_statistic = "normalized_te"
)

# 6. Plot with SHAP significance testing (requires multi-unit SHAP data)
# Run CatBoost analysis on all units
config_all_units <- create_catboost_config(
  dataset_name = "example",
  treated_unit_name = "TREATED_ID",
  treated_unit_only = FALSE   # Analyze all units for significance testing
)
shap_all_units <- run_catboost_shap_analysis(spec_results_long, config_all_units)

# Plot with automatic SHAP significance testing (absolute method, default)
plot_with_shap_significance_abs <- plot_spec_curve(
  long_data = spec_results_long,
  name_treated_unit = "TREATED_ID",
  shap_values = shap_all_units$shapley,   # Multi-unit SHAP data
  calculate_shap_pvalues = TRUE   # Enable significance testing (default)
)
# Displays SHAP values with transparency indicating statistical significance (absolute)

# Plot with SHAP significance testing using signed p-values
plot_with_shap_significance_signed <- plot_spec_curve(
  long_data = spec_results_long,
  name_treated_unit = "TREATED_ID",
  shap_values = shap_all_units$shapley,
  calculate_shap_pvalues = TRUE,
  shap_pvalue_type = "signed" # New option
)

# 7. Disable SHAP significance testing if not wanted
plot_no_shap_significance <- plot_spec_curve(
  long_data = spec_results_long,
  name_treated_unit = "TREATED_ID",
  shap_values = shap_all_units$shapley,
  calculate_shap_pvalues = FALSE   # Disable significance testing
)

}
}
